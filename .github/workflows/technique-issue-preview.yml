name: Technique Issue Preview

on:
  issues:
    types: [opened, reopened]

permissions:
  issues: write

jobs:
  preview:
    if: "${{ contains(github.event.issue.labels.*.name, 'content: new technique') && contains(github.event.issue.labels.*.name, 'form input') }}"
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.12
      uses: actions/setup-python@v3
      with:
        python-version: "3.12"

    - name: Write issue body to file
      run: printenv ISSUE_BODY > issue_body.md
      env:
        ISSUE_BODY: ${{ github.event.issue.body }}

    - name: Generate JSON preview comment
      run: |
        python3 admin/parse_technique_issue.py \
          --issue-body-file issue_body.md \
          --output comment.md

    - name: Post comment on issue
      run: |
        gh issue comment "$ISSUE_NUMBER" --body-file comment.md
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        ISSUE_NUMBER: ${{ github.event.issue.number }}
